---
- name: Install kubernetes dependencies 
  hosts: all
  become: true 
  vars_files: 
    - vars/config.yml
  tasks: 

    # - name: check if swap file exits
    #   stat: 
    #     path: /swapfile 
    #   register: swap_file_check

    - block: 
      - name: turn off swap 
        command: swapoff -a

      - name: remove swap entry in fstab 
        replace:
          path: /etc/fstab
          regexp: '^(\s*)([^#\n]+\s+)(\w+\s+)swap(\s+.*)$'
          replace: '#\1\2\3swap\4'
          backup: yes
      # when: swap_file_check.stat.exists

    - name: install kublet, kubeadm and kubeclt 
      ansible.builtin.apt: 
        pkg: 
          - kubelet={{ kubernetes_version }}-00
          - kubeadm={{ kubernetes_version }}-00
          - kubectl={{ kubernetes_version }}-00
    
    - block: 
        - name: load overlay kernel module
          ansible.builtin.command: modprobe overlay

        - name:  load br_netfilter kernel module 
          ansible.builtin.command: modprobe br_netfilter

        - name: install containerd
          ansible.builtin.apt: 
            name: containerd.io 
            state: present

        


